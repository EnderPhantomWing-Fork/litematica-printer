name: build
on:
  push:
    paths-ignore:
      - '*.md'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      # å…è®¸åˆ é™¤äº‘ç«¯ç¼“å­˜
      actions: write
    steps:
      # 1. æ‹‰å–ä»£ç ï¼ˆåŸºç¡€æ­¥éª¤ï¼‰
      - name: checkout repository
        uses: actions/checkout@v4

      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: setup jdk
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'

      # 2. åŠ è½½ç¼“å­˜é…ç½®ï¼ˆæ ¸å¿ƒé…ç½®è¯»å–ï¼‰
      - name: Load Gradle cache config
        id: load_cache_config
        run: |
          # å®‰è£…yqï¼ˆè§£æYAMLé…ç½®æ–‡ä»¶ï¼‰
          sudo apt update -o Acquire::Update::Parallel=true && sudo apt install -y yq
          
          CONFIG_FILE=".github/gradle-cache-config.yml"
          
          # è¯»å–é…ç½®å€¼ï¼ˆä¸å­˜åœ¨åˆ™ç”¨é»˜è®¤å€¼ï¼‰
          CLEAN_OLD_DAYS=$(yq -r '.cache.clean_old_days' "$CONFIG_FILE" || echo 8)
          CACHE_PATHS=$(yq -r '.cache.cache_paths | @sh' "$CONFIG_FILE" || echo "~/.gradle/caches ~/.gradle/wrapper ./.gradle")
          BASE_PREFIX=$(yq -r '.cache.cache_key_prefix' "$CONFIG_FILE" || echo "gradle-common")
          CACHE_KEY_PREFIX="${{ runner.os }}-$BASE_PREFIX"
          CLEAN_ON_PR=$(yq -r '.cache.clean_on_pr' "$CONFIG_FILE" || echo false)
          
          # è¾“å‡ºå˜é‡
          echo "clean_old_days=$CLEAN_OLD_DAYS" >> $GITHUB_OUTPUT
          echo "cache_paths=$CACHE_PATHS" >> $GITHUB_OUTPUT
          echo "cache_key_prefix=$CACHE_KEY_PREFIX" >> $GITHUB_OUTPUT
          echo "clean_on_pr=$CLEAN_ON_PR" >> $GITHUB_OUTPUT
          
          # æ‰“å°é…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "ğŸ“Œ åŠ è½½çš„ç¼“å­˜é…ç½®ï¼š"
          echo "  æ¸…ç†è¶…è¿‡ $CLEAN_OLD_DAYS å¤©çš„æ–‡ä»¶"
          echo "  ç¼“å­˜è·¯å¾„ï¼š$CACHE_PATHS"
          echo "  ç¼“å­˜é”®å‰ç¼€ï¼š$CACHE_KEY_PREFIX"
          echo "  PRè§¦å‘æ—¶æ¸…ç†ï¼š$CLEAN_ON_PR"

      # 3. æ¸…ç†æ—§ç¼“å­˜ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
      - name: Clean old Gradle files (config-driven)
        if: >
          (github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch') || 
          (github.event_name == 'pull_request' && steps.load_cache_config.outputs.clean_on_pr == 'true')
        run: |
          CLEAN_DAYS=${{ steps.load_cache_config.outputs.clean_old_days }}
          CACHE_PATHS=($(eval echo ${{ steps.load_cache_config.outputs.cache_paths }}))
          
          echo "ğŸ” å¼€å§‹æ¸…ç†è¶…è¿‡ $CLEAN_DAYS å¤©çš„Gradleç¼“å­˜æ–‡ä»¶..."
          for dir in "${CACHE_PATHS[@]}"; do
            abs_dir=$(realpath "$dir" 2>/dev/null || true)
            if [ -d "$abs_dir" ]; then
              echo "ğŸ“‚ æ¸…ç†ç›®å½•ï¼š$abs_dir"
              find "$abs_dir" -type f -mtime +"$CLEAN_DAYS" -delete
              find "$abs_dir" -type d -empty -delete
              echo "âœ… ç›®å½• $abs_dir æ¸…ç†å®Œæˆ"
            else
              echo "âš ï¸ ç›®å½• $dirï¼ˆè§£æåï¼š$abs_dirï¼‰ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

      - name: Clean redundant cloud cache (config-driven)
        if: >
          (github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch') || 
          (github.event_name == 'pull_request' && steps.load_cache_config.outputs.clean_on_pr == 'true')
        run: |
          sudo apt update -o Acquire::Update::Parallel=true && sudo apt install -y gh
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          CACHE_PREFIX=${{ steps.load_cache_config.outputs.cache_key_prefix }}
          echo "ğŸ” æ¸…ç†äº‘ç«¯ç¼“å­˜ï¼ˆå‰ç¼€ï¼š$CACHE_PREFIXï¼‰..."
          
          CACHE_LIST=$(gh cache list --limit 200 | grep "$CACHE_PREFIX" | sort -k3r)
          if [ -n "$CACHE_LIST" ]; then
            LATEST_ID=$(echo "$CACHE_LIST" | head -n1 | awk '{print $1}')
            echo "ğŸ”’ ä¿ç•™æœ€æ–°äº‘ç«¯ç¼“å­˜IDï¼š$LATEST_ID"
            echo "$CACHE_LIST" | tail -n +2 | while read -r cache_id _ _; do
              [ -n "$cache_id" ] && gh cache delete "$cache_id" --confirm
            done
            echo "âœ… äº‘ç«¯ç¼“å­˜æ¸…ç†å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„äº‘ç«¯ç¼“å­˜ï¼Œè·³è¿‡"
          fi

      # 4. å…ˆæ‰§è¡Œæ„å»ºï¼ˆå…³é”®è°ƒæ•´ï¼šæ„å»ºåœ¨ç¼“å­˜ä¸Šä¼ å‰ï¼‰
      - name: make gradle wrapper executable
        run: chmod +x ./gradlew

      - name: build fabricWrapper subproject
        run: ./gradlew :fabricWrapper:build --stacktrace

      # 5. æ„å»ºå®Œæˆåï¼Œä¸Šä¼ æœ€æ–°çš„Gradleç¼“å­˜
      - name: Cache Gradle dependencies (config-driven)
        uses: actions/cache@v4
        with:
          path: ${{ steps.load_cache_config.outputs.cache_paths }}
          key: ${{ steps.load_cache_config.outputs.cache_key_prefix }}

      # 6. æœ€åä¸Šä¼ æ„å»ºäº§ç‰©
      - name: capture build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: fabricWrapper/build/libs/