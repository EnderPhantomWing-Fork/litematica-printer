name: build
on:
  push:
    paths-ignore:
      - '*.md'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      # å…è®¸åˆ é™¤äº‘ç«¯ç¼“å­˜
      actions: write
    steps:
      # å…ˆæ‹‰å–ä»£ç ï¼Œæ‰èƒ½è¯»å–é¡¹ç›®å†…çš„é…ç½®æ–‡ä»¶
      - name: checkout repository
        uses: actions/checkout@v4

      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: setup jdk
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'

      # ========== æ ¸å¿ƒï¼šè¯»å–é¡¹ç›®å†…çš„ç¼“å­˜é…ç½®æ–‡ä»¶ ==========
      - name: Load Gradle cache config
        id: load_cache_config
        run: |
          # å®‰è£…yqï¼ˆè§£æYAMLé…ç½®æ–‡ä»¶ï¼Œä¼˜åŒ–æ›´æ–°é€Ÿåº¦ï¼‰
          sudo apt update -o Acquire::Update::Parallel=true && sudo apt install -y yq
          
          # é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé¡¹ç›®å†…çš„é…ç½®æ–‡ä»¶ï¼‰
          CONFIG_FILE=".github/gradle-cache-config.yml"
          
          # è¯»å–é…ç½®å€¼ï¼ˆä¸å­˜åœ¨åˆ™ç”¨é»˜è®¤å€¼ï¼‰
          CLEAN_OLD_DAYS=$(yq -r '.cache.clean_old_days' "$CONFIG_FILE" || echo 8)
          CACHE_PATHS=$(yq -r '.cache.cache_paths | @sh' "$CONFIG_FILE" || echo "~/.gradle/caches ~/.gradle/wrapper ./.gradle")
          # æ‹¼æ¥ç³»ç»Ÿååˆ°ç¼“å­˜å‰ç¼€ï¼ˆä¿®å¤å˜é‡è§£æï¼‰
          BASE_PREFIX=$(yq -r '.cache.cache_key_prefix' "$CONFIG_FILE" || echo "gradle-common")
          CACHE_KEY_PREFIX="${{ runner.os }}-$BASE_PREFIX"
          CLEAN_ON_PR=$(yq -r '.cache.clean_on_pr' "$CONFIG_FILE" || echo false)
          
          # å°†é…ç½®å€¼è¾“å‡ºä¸ºæ­¥éª¤å˜é‡ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "clean_old_days=$CLEAN_OLD_DAYS" >> $GITHUB_OUTPUT
          echo "cache_paths=$CACHE_PATHS" >> $GITHUB_OUTPUT
          echo "cache_key_prefix=$CACHE_KEY_PREFIX" >> $GITHUB_OUTPUT
          echo "clean_on_pr=$CLEAN_ON_PR" >> $GITHUB_OUTPUT
          
          # æ‰“å°é…ç½®å€¼ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          echo "ğŸ“Œ åŠ è½½çš„ç¼“å­˜é…ç½®ï¼š"
          echo "  æ¸…ç†è¶…è¿‡ $CLEAN_OLD_DAYS å¤©çš„æ–‡ä»¶"
          echo "  ç¼“å­˜è·¯å¾„ï¼š$CACHE_PATHS"
          echo "  ç¼“å­˜é”®å‰ç¼€ï¼š$CACHE_KEY_PREFIX"
          echo "  PRè§¦å‘æ—¶æ¸…ç†ï¼š$CLEAN_ON_PR"

      # ========== æ ¹æ®é…ç½®æ‰§è¡Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶æ¸…ç† ==========
      - name: Clean old Gradle files (config-driven)
        if: >
          (github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch') || 
          (github.event_name == 'pull_request' && steps.load_cache_config.outputs.clean_on_pr == 'true')
        run: |
          # ä»æ­¥éª¤è¾“å‡ºè¯»å–é…ç½®å€¼
          CLEAN_DAYS=${{ steps.load_cache_config.outputs.clean_old_days }}
          # å®‰å…¨è§£æè·¯å¾„ï¼ˆå¤„ç†~å’Œç¯å¢ƒå˜é‡ï¼‰
          CACHE_PATHS=($(eval echo ${{ steps.load_cache_config.outputs.cache_paths }}))
          
          echo "ğŸ” å¼€å§‹æ¸…ç†è¶…è¿‡ $CLEAN_DAYS å¤©çš„Gradleç¼“å­˜æ–‡ä»¶..."
          
          # éå†é…ç½®çš„ç¼“å­˜è·¯å¾„ï¼Œæ‰§è¡Œæ¸…ç†
          for dir in "${CACHE_PATHS[@]}"; do
            # è§£æç»å¯¹è·¯å¾„
            abs_dir=$(realpath "$dir" 2>/dev/null || true)
            if [ -d "$abs_dir" ]; then
              echo "ğŸ“‚ æ¸…ç†ç›®å½•ï¼š$abs_dir"
              # åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ–‡ä»¶
              find "$abs_dir" -type f -mtime +"$CLEAN_DAYS" -delete
              # åˆ é™¤ç©ºç›®å½•
              find "$abs_dir" -type d -empty -delete
              echo "âœ… ç›®å½• $abs_dir æ¸…ç†å®Œæˆ"
            else
              echo "âš ï¸ ç›®å½• $dirï¼ˆè§£æåï¼š$abs_dirï¼‰ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

      # ========== æ ¹æ®é…ç½®æ¸…ç†äº‘ç«¯å†—ä½™ç¼“å­˜ ==========
      - name: Clean redundant cloud cache (config-driven)
        if: >
          (github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch') || 
          (github.event_name == 'pull_request' && steps.load_cache_config.outputs.clean_on_pr == 'true')
        run: |
          # å®‰è£…GitHub CLIï¼ˆä¼˜åŒ–æ›´æ–°é€Ÿåº¦ï¼‰
          sudo apt update -o Acquire::Update::Parallel=true && sudo apt install -y gh
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # ä»æ­¥éª¤è¾“å‡ºè¯»å–ç¼“å­˜é”®å‰ç¼€
          CACHE_PREFIX=${{ steps.load_cache_config.outputs.cache_key_prefix }}
          echo "ğŸ” æ¸…ç†äº‘ç«¯ç¼“å­˜ï¼ˆå‰ç¼€ï¼š$CACHE_PREFIXï¼‰..."
          
          # åˆ—å‡ºæ›´å¤šåŒ¹é…ç¼“å­˜ï¼ˆæå‡åˆ°200æ¡é¿å…æ¼åˆ ï¼‰
          CACHE_LIST=$(gh cache list --limit 200 | grep "$CACHE_PREFIX" | sort -k3r)
          
          if [ -n "$CACHE_LIST" ]; then
            # ä¿ç•™æœ€æ–°1ä»½ï¼Œåˆ é™¤å…¶ä½™
            LATEST_ID=$(echo "$CACHE_LIST" | head -n1 | awk '{print $1}')
            echo "ğŸ”’ ä¿ç•™æœ€æ–°äº‘ç«¯ç¼“å­˜IDï¼š$LATEST_ID"
            # åˆ é™¤éæœ€æ–°çš„ç¼“å­˜
            echo "$CACHE_LIST" | tail -n +2 | while read -r cache_id _ _; do
              [ -n "$cache_id" ] && gh cache delete "$cache_id" --confirm
            done
            echo "âœ… äº‘ç«¯ç¼“å­˜æ¸…ç†å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„äº‘ç«¯ç¼“å­˜ï¼Œè·³è¿‡"
          fi

      # ========== æ ¹æ®é…ç½®æ‰§è¡ŒGradleç¼“å­˜ ==========
      - name: Cache Gradle dependencies (config-driven)
        uses: actions/cache@v4  # å‡çº§åˆ°æœ€æ–°ç‰ˆ
        with:
          # ä»é…ç½®è¯»å–ç¼“å­˜è·¯å¾„
          path: ${{ steps.load_cache_config.outputs.cache_paths }}
          # ä»é…ç½®è¯»å–ç¼“å­˜é”®å‰ç¼€
          key: ${{ steps.load_cache_config.outputs.cache_key_prefix }}

      - name: make gradle wrapper executable
        run: chmod +x ./gradlew

      # ========== ç¼–è¯‘ ==========
      - name: build fabricWrapper subproject
        run: ./gradlew :fabricWrapper:build --stacktrace

      - name: capture build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: fabricWrapper/build/libs/